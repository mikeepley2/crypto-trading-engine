# Crypto Trading Engine Copilot Instructions

**CRITICAL REQUIREMENT: NEVER CREATE SIMPLIFIED VERSIONS**
You must NEVER create simplified, basic, or minimal versions of anything. ALWAYS create comprehensive, optimal, production-ready solutions. When implementing features, models, systems, or any code - make them complete, robust, and enterprise-grade from the start.

**CRITICAL: LIVE TRADING SYSTEM - REAL MONEY**
This is a LIVE trading system currently operational with real money ($2,571.86 portfolio, 3,784% growth). Exercise extreme caution with any changes to trading logic, risk management, or execution systems.

## System Overview
The crypto trading engine is a production-ready AI-powered automated cryptocurrency trading system with:
- **Live Trading**: Currently operational with real money via Coinbase Advanced Trade API
- **ML Accuracy**: 66.5% prediction accuracy using XGBoost models trained on 1.4M records
- **AI Integration**: 8 operational LLM models for risk assessment and market analysis
- **Real-time Processing**: Generating trading signals every 5 minutes
- **Portfolio Growth**: 3,784% returns from initial investment

## Architecture Guidelines

### **ðŸš¨ CRITICAL SAFETY RULES**
1. **NEVER modify trade execution logic without extensive testing**
2. **ALWAYS use mock mode for testing new features**
3. **PRESERVE all risk management and safety mechanisms**
4. **VALIDATE all database schema changes thoroughly**
5. **MAINTAIN backward compatibility for live trading system**

### **Trading Engine Components**
- **Signal Generator** (Port 8025): XGBoost ML models generating BUY/SELL signals
- **Trade Execution** (Port 8024): Live Coinbase API integration with real money
- **Signal Bridge** (Port 8022): ML signal to trade conversion with risk checks
- **Portfolio Rebalancer** (Port 8047): Portfolio-aware position management

### **Database Configuration**
- **Host**: ALWAYS use `host.docker.internal` for Windows MySQL connectivity
- **User**: ALWAYS use `news_collector` with password `99Rules!`
- **Trading Database**: `crypto_transactions` for live trading data
- **ML Database**: `crypto_prices` for ML features and historical data

### **Kubernetes Deployment**
- **Namespace**: `crypto-trading` for all trading services
- **NEVER run services directly with Python** - ALWAYS use Kubernetes
- **Health Checks**: All services must expose /health endpoints
- **Secrets**: API keys stored as Kubernetes secrets only

## Development Workflow

### **1. Safety First**
- **Mock Mode**: ALWAYS test in mock mode first (`TRADING_MODE=mock`)
- **Backup**: Create database backups before schema changes
- **Staging**: Test all changes in staging environment
- **Monitoring**: Verify all health endpoints after changes

### **2. Code Standards**
```python
# Database connections (REQUIRED pattern)
db_config = {
    'host': 'host.docker.internal',
    'user': 'news_collector', 
    'password': '99Rules!',
    'database': 'crypto_transactions'  # or crypto_prices
}
```

### **3. Testing Requirements**
- **Unit Tests**: All new code must have pytest coverage
- **Integration Tests**: Test API endpoints and database connectivity
- **Mock Trading**: Validate trading logic with mock trades
- **Performance Tests**: Ensure <100ms signal generation latency

### **4. Deployment Process**
```bash
# 1. Deploy to Kubernetes (NEVER run Python directly)
kubectl apply -f k8s/ -n crypto-trading

# 2. Verify health
curl http://localhost:8025/health  # Signal generator
curl http://localhost:8024/health  # Trade execution

# 3. Monitor logs
kubectl logs -n crypto-trading deployment/signal-generator -f
```

## Risk Management

### **Position Limits**
- **Maximum Position Size**: 5% of portfolio per asset
- **Stop Loss**: Dynamic based on volatility (2-5%)
- **Portfolio Exposure**: Maximum 80% invested (20% cash)
- **Correlation Limits**: Avoid highly correlated positions

### **Emergency Procedures**
```bash
# Emergency stop all trading
kubectl scale deployment/trade-execution --replicas=0 -n crypto-trading

# Emergency liquidation (use with extreme caution)
curl -X POST http://localhost:8024/emergency/liquidate-all \
  -H "Content-Type: application/json" \
  -d '{"confirm": true}'
```

## ML/AI Integration

### **XGBoost Models**
- **Features**: 83/86 features (96.5% coverage) including technical, sentiment, macro data
- **Training Data**: 1.4M historical records spanning 2019-2025
- **Model Updates**: Retrain weekly with fresh market data
- **Validation**: Backtesting on 6-month rolling windows

### **LLM Integration**
- **Risk Assessment**: LLM-powered portfolio risk analysis
- **Market Context**: Contextual analysis for trading decisions
- **Model Ensemble**: Multiple specialized models for different tasks

### **Feature Engineering**
- **Real-time Features**: Technical indicators, sentiment scores, macro data
- **Data Pipeline**: Materialized features updated every 15 minutes
- **Quality Checks**: Data validation and outlier detection

## API Guidelines

### **Trading API Endpoints**
- **Signal Generation**: `GET /signals/latest` for current trading signals
- **Portfolio Status**: `GET /portfolio` for current positions and PnL
- **Trade Execution**: `POST /trades/execute` for executing trades
- **Health Monitoring**: `GET /health` for service status

### **Authentication**
- **API Keys**: Stored in Kubernetes secrets
- **Internal Auth**: Service-to-service via K8s service accounts
- **Rate Limiting**: Respect exchange rate limits (Coinbase: 10 req/sec)

## Monitoring & Observability

### **Health Monitoring**
- **Service Health**: All services expose /health endpoints
- **Database Health**: Monitor connection pools and query performance
- **Trading Health**: Monitor signal generation and trade execution rates

### **Performance Metrics**
- **Signal Accuracy**: Track ML prediction accuracy over time
- **Trading Performance**: Monitor portfolio PnL and risk metrics
- **System Performance**: Monitor latency and throughput

### **Alerting**
- **Critical Alerts**: Trading failures, API errors, database issues
- **Performance Alerts**: High latency, low accuracy, risk limit breaches
- **System Alerts**: Service health, resource usage, deployment issues

## Security Best Practices

### **API Security**
- **Credentials**: Never hardcode API keys or passwords
- **Encryption**: TLS for all external communications
- **Secrets Management**: Kubernetes secrets with rotation
- **Access Control**: Principle of least privilege

### **Database Security**
- **Authentication**: Strong passwords and user accounts
- **Encryption**: TLS connections to database
- **Backup**: Regular encrypted backups
- **Access Logging**: Audit all database operations

## Troubleshooting

### **Common Issues**
1. **Signal Generation Stopped**: Check ML model availability and data pipeline
2. **Trade Execution Errors**: Verify API connectivity and rate limits
3. **Database Connection Issues**: Check host.docker.internal connectivity
4. **Kubernetes Pod Issues**: Check resource limits and health probes

### **Debug Commands**
```bash
# Check service status
kubectl get pods -n crypto-trading

# View service logs
kubectl logs -n crypto-trading deployment/signal-generator -f

# Test database connectivity
mysql -h host.docker.internal -u news_collector -p99Rules! -e "SHOW DATABASES;"

# Test API endpoints
curl http://localhost:8025/health | jq
```

## File Organization

### **Service Structure**
```
services/
â”œâ”€â”€ engines/          # Core trading engines
â”œâ”€â”€ signals/          # Signal generation services  
â”œâ”€â”€ portfolio/        # Portfolio management
â”œâ”€â”€ risk/            # Risk management
â”œâ”€â”€ analytics/       # Trading analytics
â””â”€â”€ shared/          # Shared utilities and schemas
```

### **Configuration Management**
- **Kubernetes ConfigMaps**: Environment-specific configuration
- **Secrets**: API keys and sensitive data
- **Environment Variables**: Runtime configuration
- **Database Migrations**: Schema evolution tracking

### **Logging Standards**
- **Structured Logging**: JSON format with standardized fields
- **Log Levels**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **Context**: Include request IDs and user context
- **Sensitive Data**: Never log API keys or trading amounts

Remember: This is a LIVE trading system with real money. Always prioritize safety, testing, and risk management in all development activities.